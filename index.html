<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visor 3D Gyro</title>
    <style>
        body {
            background-color: #000;
            margin: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
            font-family: sans-serif;
        }

        #intro-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }

        #start-btn {
            background: transparent; color: white; border: 1px solid rgba(255,255,255,0.6);
            padding: 15px 40px; font-size: 1rem; text-transform: uppercase;
            letter-spacing: 3px; cursor: pointer; border-radius: 50px;
            transition: all 0.3s;
        }

        #start-btn:hover { background: white; color: black; }

        .viewer-container {
            position: relative;
            width: 100%; max-width: 100%;
            aspect-ratio: 1.56 / 1; 
            background-color: #000;
            cursor: grab; touch-action: none; user-select: none;
            -webkit-tap-highlight-color: transparent; 
            opacity: 0; transition: opacity 1s ease;
            overflow: hidden;
        }

        .viewer-container.active { opacity: 1; }
        .viewer-container:active { cursor: grabbing; }

        #product-image {
            width: 100%; height: 100%;
            object-fit: fill; 
            display: block; pointer-events: none; -webkit-user-drag: none;
            transform-origin: center center;
            transition: transform 0.3s cubic-bezier(0.25, 1, 0.5, 1);
            transform: scale(1);
        }
        
        #product-image.at-edge { transform: scale(1.015); }

        #demo-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; pointer-events: none; }
        
        /* Indicador de Gyro Activo */
        .gyro-indicator {
            position: absolute; top: 20px; right: 20px;
            width: 10px; height: 10px; border-radius: 50%;
            background-color: #00ff00; box-shadow: 0 0 10px #00ff00;
            opacity: 0; transition: opacity 0.5s; pointer-events: none;
        }
        .gyro-indicator.on { opacity: 0.5; }

    </style>
</head>
<body>

    <div id="intro-overlay">
        <button id="start-btn" onclick="solicitarPermisosYArrancar()">Iniciar Experiencia</button>
        <p style="color: #666; margin-top: 20px; font-size: 0.8rem;">Inclina tu teléfono o desliza el dedo</p>
    </div>

    <div class="viewer-container" id="container">
        <canvas id="demo-canvas"></canvas>
        <img id="product-image" src="" alt="Modelo 3D">
        <div class="gyro-indicator" id="gyro-dot"></div>
    </div>

    <script>
        // ==========================================
        // CONFIGURACIÓN
        // ==========================================
        const config = {
            totalX: 16,        
            totalY: 16,        
            folderPath: "renders/", 
            filePrefix: "modelo",   
            fileExtension: ".jpg",  
            thresholdPx: 5, // Para el dedo
            
            // CONFIGURACIÓN GIROSCOPIO
            tiltThreshold: 15, // Grados de inclinación para activar el cambio
            resetThreshold: 5  // Grados para considerar que volvió al centro
        };

        // ==========================================
        // ESTADO
        // ==========================================
        let state = {
            currentX: 8, 
            currentY: 8,
            isDragging: false,
            startX: 0, startY: 0,
            hasMovedInThisStroke: false,

            // ESTADO GIROSCOPIO
            gyroActive: false,
            isTiltedX: false, // ¿Ya se disparó el evento horizontal?
            isTiltedY: false  // ¿Ya se disparó el evento vertical?
        };

        const container = document.getElementById('container');
        const imgElement = document.getElementById('product-image');
        const demoCanvas = document.getElementById('demo-canvas');
        const introOverlay = document.getElementById('intro-overlay');
        const gyroDot = document.getElementById('gyro-dot');
        let demoActive = false;

        // ==========================================
        // CARGA
        // ==========================================
        imgElement.onload = function() {
            demoActive = false;
            demoCanvas.style.display = 'none';
            imgElement.style.display = 'block';
        };
        imgElement.onerror = function() {
            if(imgElement.src && imgElement.src !== window.location.href) activarModoDemo();
        };

        // ==========================================
        // INICIO + PERMISOS IOS (CRUCIAL)
        // ==========================================
        function solicitarPermisosYArrancar() {
            // Intentar pedir permiso para iOS 13+
            if (typeof DeviceOrientationEvent !== 'undefined' && typeof DeviceOrientationEvent.requestPermission === 'function') {
                DeviceOrientationEvent.requestPermission()
                    .then(permissionState => {
                        if (permissionState === 'granted') {
                            window.addEventListener('deviceorientation', handleOrientation);
                            state.gyroActive = true;
                            gyroDot.classList.add('on');
                        }
                        iniciarInterfaz();
                    })
                    .catch(console.error);
            } else {
                // No es iOS 13+ o es Android (usualmente no pide permiso o funciona directo)
                window.addEventListener('deviceorientation', handleOrientation);
                state.gyroActive = true;
                gyroDot.classList.add('on');
                iniciarInterfaz();
            }
        }

        function iniciarInterfaz() {
            const docEl = document.documentElement;
            if (docEl.requestFullscreen) docEl.requestFullscreen();
            else if (docEl.webkitRequestFullscreen) docEl.webkitRequestFullscreen();
            
            introOverlay.style.opacity = '0';
            setTimeout(() => {
                introOverlay.style.display = 'none';
                container.classList.add('active');
                updateImageDOM(state.currentX, state.currentY); 
            }, 500);
        }

        // ==========================================
        // LÓGICA DE ACTUALIZACIÓN
        // ==========================================
        function getFilename(x, y) {
            let safeX = Math.max(0, Math.min(config.totalX - 1, x));
            let safeY = Math.max(0, Math.min(config.totalY - 1, y));
            let imageNumber = (safeX * config.totalY) + safeY;
            return `${config.folderPath}${config.filePrefix}${imageNumber.toString().padStart(4, '0')}${config.fileExtension}`;
        }

        function updateImageDOM(newX, newY) {
            const filename = getFilename(newX, newY);
            if (!imgElement.src.includes(filename)) {
                imgElement.src = filename;
                state.currentX = newX;
                state.currentY = newY;
            }
            if (demoActive) drawDemoCube(newX, newY, filename);

            // Precarga
            const neighbors = [{x: newX+1, y: newY}, {x: newX-1, y: newY}, {x: newX, y: newY+1}, {x: newX, y: newY-1}];
            neighbors.forEach(n => {
                if (n.x >= 0 && n.x < config.totalX && n.y >= 0 && n.y < config.totalY) {
                    (new Image()).src = getFilename(n.x, n.y);
                }
            });
        }

        function triggerEdgeFeedback() {
            imgElement.classList.add('at-edge');
            setTimeout(() => imgElement.classList.remove('at-edge'), 150);
        }

        // ==========================================
        // LÓGICA DEL GIROSCOPIO (GATILLO)
        // ==========================================
        function handleOrientation(event) {
            // Gamma: Inclinación Izquierda(-90) a Derecha(90)
            // Beta: Inclinación Frente(-180) a Atrás(180)
            
            // Limitamos Beta para evitar saltos locos al poner el tlf plano
            let tiltX = event.gamma; // Horizontal
            let tiltY = event.beta;  // Vertical

            // --- EJE X (HORIZONTAL) ---
            if (tiltX > config.tiltThreshold) { // Inclinado a DERECHA
                if (!state.isTiltedX) {
                    // Disparo único
                    if (state.currentX > 0) updateImageDOM(state.currentX - 1, state.currentY);
                    else triggerEdgeFeedback();
                    state.isTiltedX = true; // Bloqueado hasta volver al centro
                }
            } else if (tiltX < -config.tiltThreshold) { // Inclinado a IZQUIERDA
                if (!state.isTiltedX) {
                    if (state.currentX < config.totalX - 1) updateImageDOM(state.currentX + 1, state.currentY);
                    else triggerEdgeFeedback();
                    state.isTiltedX = true;
                }
            } else if (Math.abs(tiltX) < config.resetThreshold) {
                // Volvió al CENTRO -> Resetear gatillo
                state.isTiltedX = false;
            }

            // --- EJE Y (VERTICAL) ---
            // Nota: Restamos 45 aprox porque la gente sostiene el tlf inclinado, no plano.
            // O usamos cambio relativo. Para simplificar, usaremos Beta directo pero con cuidado.
            // Lo ideal es calibrar al inicio, pero aquí usaremos umbrales simples.
            // Asumimos que sostienes el teléfono a unos 45 grados (Beta = 45).
            // Arriba < 30, Abajo > 60.
            
            // Vamos a usar lógica relativa simple: 
            // Si Beta cambia bruscamente. Pero para "gatillo" necesitamos referencia.
            // Usemos un rango "seguro" de 30 a 60 grados como centro vertical.
            
            // SIMPLIFICACIÓN: Beta > 60 (Abajo), Beta < 30 (Arriba)
            // Ajusta estos valores según sientas la comodidad
            
            /* Lógica Vertical Gyro (Opcional, a veces marea, descomentar si se desea) 
            if (tiltY > 60) { // Inclinado hacia ti (Abajo)
                if (!state.isTiltedY) {
                     if (state.currentY < config.totalY - 1) updateImageDOM(state.currentX, state.currentY + 1);
                     else triggerEdgeFeedback();
                     state.isTiltedY = true;
                }
            } else if (tiltY < 30) { // Inclinado hacia el frente (Arriba)
                if (!state.isTiltedY) {
                    if (state.currentY > 0) updateImageDOM(state.currentX, state.currentY - 1);
                    else triggerEdgeFeedback();
                    state.isTiltedY = true;
                }
            } else if (tiltY > 35 && tiltY < 55) {
                state.isTiltedY = false;
            }
            */
        }


        // ==========================================
        // LÓGICA TÁCTIL (Mantiene la que ya funcionaba)
        // ==========================================
        function startDrag(clientX, clientY) {
            state.isDragging = true;
            state.startX = clientX; state.startY = clientY;
            state.hasMovedInThisStroke = false;
            container.style.cursor = 'grabbing';
        }

        function onDrag(clientX, clientY) {
            if (!state.isDragging || state.hasMovedInThisStroke) return;
            const deltaX = clientX - state.startX;
            const deltaY = clientY - state.startY;

            if (Math.abs(deltaX) > config.thresholdPx || Math.abs(deltaY) > config.thresholdPx) {
                let moved = false;
                if (Math.abs(deltaX) > Math.abs(deltaY)) {
                    if (deltaX > 0) { 
                        if (state.currentX > 0) { updateImageDOM(state.currentX - 1, state.currentY); moved = true; }
                    } else { 
                        if (state.currentX < config.totalX - 1) { updateImageDOM(state.currentX + 1, state.currentY); moved = true; }
                    }
                } else {
                    if (deltaY > 0) { 
                        if (state.currentY < config.totalY - 1) { updateImageDOM(state.currentX, state.currentY + 1); moved = true; }
                    } else { 
                        if (state.currentY > 0) { updateImageDOM(state.currentX, state.currentY - 1); moved = true; }
                    }
                }
                if (!moved) {
                    imgElement.classList.add('at-edge');
                }
                state.hasMovedInThisStroke = true;
            }
        }

        function stopDrag() {
            state.isDragging = false;
            container.style.cursor = 'grab';
            imgElement.classList.remove('at-edge');
        }

        // Listeners
        container.addEventListener('mousedown', (e) => { e.preventDefault(); startDrag(e.clientX, e.clientY); });
        window.addEventListener('mousemove', (e) => { if(state.isDragging) onDrag(e.clientX, e.clientY); });
        window.addEventListener('mouseup', stopDrag);
        window.addEventListener('mouseleave', stopDrag);
        container.addEventListener('touchstart', (e) => { const t = e.touches[0]; startDrag(t.clientX, t.clientY); }, { passive: false });
        window.addEventListener('touchmove', (e) => { if (state.isDragging) { const t = e.touches[0]; onDrag(t.clientX, t.clientY); } }, { passive: false });
        window.addEventListener('touchend', stopDrag);

        // MODO DEMO
        function activarModoDemo() {
            demoActive = true; imgElement.style.display = 'none'; demoCanvas.style.display = 'block';
            demoCanvas.width = container.clientWidth; demoCanvas.height = container.clientHeight;
        }
        function drawDemoCube(x, y, name) {
            const ctx = demoCanvas.getContext('2d'); ctx.clearRect(0, 0, demoCanvas.width, demoCanvas.height);
            ctx.fillStyle = "#111"; ctx.fillRect(0,0,demoCanvas.width, demoCanvas.height);
            ctx.save(); ctx.translate(demoCanvas.width/2, demoCanvas.height/2);
            if(imgElement.classList.contains('at-edge')) ctx.scale(1.015, 1.015);
            ctx.scale(1.56, 1); 
            ctx.strokeStyle = "#0f0"; ctx.lineWidth = 4; 
            ctx.strokeRect(-100 + ((x-8)*10), -100 + ((y-8)*5), 200, 200);
            ctx.fillStyle = "#fff"; ctx.textAlign = "center";
            ctx.fillText("GYRO + TOUCH", 0, 0);
            ctx.restore();
        }
        window.addEventListener('resize', () => { if(demoActive) { demoCanvas.width = container.clientWidth; demoCanvas.height = container.clientHeight; }});

    </script>
</body>
</html>
