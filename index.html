<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Visor 3D Taps</title>
    <style>
        body {
            background-color: #000;
            margin: 0;
            height: 100vh;
            width: 100vw;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden; 
            font-family: 'Segoe UI', sans-serif;
            user-select: none;
            -webkit-tap-highlight-color: transparent; /* Quita el flash gris al tocar en Android */
        }

        /* === PANTALLA DE INICIO (Botón) === */
        #intro-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background-color: #000; z-index: 999;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            transition: opacity 0.5s ease;
        }

        #start-btn {
            background: transparent; color: white; border: 1px solid rgba(255,255,255,0.6);
            padding: 15px 40px; font-size: 1rem; text-transform: uppercase;
            letter-spacing: 3px; cursor: pointer; border-radius: 50px;
            transition: all 0.3s;
        }
        #start-btn:hover { background: white; color: black; }

        /* === GUIAS VISUALES (Flechas) === */
        #guide-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; /* Dejar pasar los clics */
            z-index: 50;
            display: none; /* Se activa al iniciar */
            opacity: 1;
            transition: opacity 0.5s ease;
        }

        .guide-arrow {
            position: absolute;
            color: rgba(255, 255, 255, 0.4);
            font-size: 2rem;
            animation: pulse 1.5s infinite;
        }
        .guide-arrow.top { top: 20px; left: 50%; transform: translateX(-50%); }
        .guide-arrow.bottom { bottom: 20px; left: 50%; transform: translateX(-50%); }
        .guide-arrow.left { left: 20px; top: 50%; transform: translateY(-50%); }
        .guide-arrow.right { right: 20px; top: 50%; transform: translateY(-50%); }
        
        .guide-text {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            color: rgba(255, 255, 255, 0.6);
            font-size: 0.9rem; text-align: center;
            text-transform: uppercase; letter-spacing: 1px;
            background: rgba(0,0,0,0.3);
            padding: 10px 20px; border-radius: 20px;
        }

        @keyframes pulse {
            0% { opacity: 0.2; transform: scale(1) translate(...); }
            50% { opacity: 0.8; transform: scale(1.1) translate(...); }
            100% { opacity: 0.2; transform: scale(1) translate(...); }
        }

        /* === VISOR === */
        .viewer-container {
            position: relative;
            width: 100%; max-width: 100%;
            aspect-ratio: 1.56 / 1; 
            background-color: #000;
            /* Cursor pointer para indicar que es cliqueable */
            cursor: pointer; 
            overflow: hidden;
            opacity: 0; transition: opacity 1s ease;
        }
        .viewer-container.active { opacity: 1; }

        /* === IMAGEN === */
        #product-image {
            width: 100%; height: 100%;
            object-fit: fill; 
            display: block; pointer-events: none;
            transform-origin: center center;
            transition: transform 0.15s ease-out; /* Rebote rápido */
            transform: scale(1);
        }
        
        /* Efecto rebote (tope) */
        #product-image.at-edge { transform: scale(1.02); }
        
        /* Efecto toque exitoso (sutil zoom in/out rápido) */
        #product-image.tap-effect { transform: scale(0.99); }

        #demo-canvas { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: none; pointer-events: none; }
    </style>
</head>
<body>

    <div id="intro-overlay">
        <button id="start-btn" onclick="iniciarExperiencia()">Iniciar</button>
    </div>

    <div class="viewer-container" id="container">
        
        <div id="guide-overlay">
            <div class="guide-arrow top">▲</div>
            <div class="guide-arrow bottom">▼</div>
            <div class="guide-arrow left">◀</div>
            <div class="guide-arrow right">▶</div>
            <div class="guide-text">Toca para interactuar</div>
        </div>

        <canvas id="demo-canvas"></canvas>
        <img id="product-image" src="" alt="Modelo 3D">
    </div>

    <script>
        // ==========================================
        // CONFIGURACIÓN
        // ==========================================
        const config = {
            totalX: 16,        
            totalY: 16,        
            folderPath: "renders/", 
            filePrefix: "modelo",   
            fileExtension: ".jpg"
        };

        // ==========================================
        // ESTADO
        // ==========================================
        let state = {
            currentX: 8, 
            currentY: 8,
            firstInteractionDone: false // Para saber cuándo ocultar las guías
        };

        const container = document.getElementById('container');
        const imgElement = document.getElementById('product-image');
        const demoCanvas = document.getElementById('demo-canvas');
        const introOverlay = document.getElementById('intro-overlay');
        const guideOverlay = document.getElementById('guide-overlay');
        let demoActive = false;

        // ==========================================
        // CARGA
        // ==========================================
        imgElement.onload = function() {
            demoActive = false;
            demoCanvas.style.display = 'none';
            imgElement.style.display = 'block';
        };
        imgElement.onerror = function() {
            if(imgElement.src && imgElement.src !== window.location.href) activarModoDemo();
        };

        // ==========================================
        // INICIO
        // ==========================================
        function iniciarExperiencia() {
            const docEl = document.documentElement;
            if (docEl.requestFullscreen) docEl.requestFullscreen();
            else if (docEl.webkitRequestFullscreen) docEl.webkitRequestFullscreen();
            
            introOverlay.style.opacity = '0';
            setTimeout(() => {
                introOverlay.style.display = 'none';
                container.classList.add('active');
                
                // Mostrar guías
                guideOverlay.style.display = 'block';
                
                // Cargar imagen inicial
                updateImageDOM(state.currentX, state.currentY); 
            }, 500);
        }

        // ==========================================
        // HELPER: Nombres y Precarga
        // ==========================================
        function getFilename(x, y) {
            let safeX = Math.max(0, Math.min(config.totalX - 1, x));
            let safeY = Math.max(0, Math.min(config.totalY - 1, y));
            let imageNumber = (safeX * config.totalY) + safeY;
            return `${config.folderPath}${config.filePrefix}${imageNumber.toString().padStart(4, '0')}${config.fileExtension}`;
        }

        function updateImageDOM(newX, newY) {
            const filename = getFilename(newX, newY);
            if (!imgElement.src.includes(filename)) {
                imgElement.src = filename;
                state.currentX = newX;
                state.currentY = newY;
            }
            if (demoActive) drawDemoCube(newX, newY, filename);

            // Precarga de los 4 vecinos
            const neighbors = [{x: newX+1, y: newY}, {x: newX-1, y: newY}, {x: newX, y: newY+1}, {x: newX, y: newY-1}];
            neighbors.forEach(n => {
                if (n.x >= 0 && n.x < config.totalX && n.y >= 0 && n.y < config.totalY) {
                    (new Image()).src = getFilename(n.x, n.y);
                }
            });
        }

        // ==========================================
        // FEEDBACK VISUAL (Animaciones)
        // ==========================================
        function triggerEdgeFeedback() {
            // Animación de rebote (Tope)
            imgElement.classList.add('at-edge');
            setTimeout(() => imgElement.classList.remove('at-edge'), 150);
        }

        function triggerSuccessFeedback() {
            // Animación sutil de click (hundimiento)
            imgElement.classList.remove('tap-effect'); // Reset por si acaso
            void imgElement.offsetWidth; // Trigger reflow
            imgElement.classList.add('tap-effect');
            setTimeout(() => imgElement.classList.remove('tap-effect'), 150);
        }

        function hideGuides() {
            if (!state.firstInteractionDone) {
                guideOverlay.style.opacity = '0';
                setTimeout(() => { guideOverlay.style.display = 'none'; }, 500);
                state.firstInteractionDone = true;
            }
        }

        // ==========================================
        // LOGICA DE TAP (Cuadrantes)
        // ==========================================
        container.addEventListener('click', (e) => {
            hideGuides(); // Ocultar flechas al primer toque

            // Obtener dimensiones del contenedor
            const rect = container.getBoundingClientRect();
            
            // Posición del click relativa al centro del contenedor
            // (0,0) es el centro exacto
            const x = e.clientX - rect.left - (rect.width / 2);
            const y = e.clientY - rect.top - (rect.height / 2);

            let moved = false;

            // MATEMÁTICA DE CUADRANTES
            // Si el valor absoluto de X es mayor que el de Y, estamos en los lados (Izq/Der)
            // Si el valor absoluto de Y es mayor que el de X, estamos arriba o abajo.
            
            if (Math.abs(x) > Math.abs(y)) {
                // --- EJE HORIZONTAL ---
                if (x > 0) {
                    // Derecha -> Siguiente Foto (Giro horario)
                    if (state.currentX > 0) { 
                        updateImageDOM(state.currentX - 1, state.currentY); 
                        moved = true; 
                    }
                } else {
                    // Izquierda -> Foto Anterior (Giro anti-horario)
                    if (state.currentX < config.totalX - 1) { 
                        updateImageDOM(state.currentX + 1, state.currentY); 
                        moved = true; 
                    }
                }
            } else {
                // --- EJE VERTICAL ---
                if (y > 0) {
                    // Abajo -> Bajar vista
                    if (state.currentY < config.totalY - 1) { 
                        updateImageDOM(state.currentX, state.currentY + 1); 
                        moved = true; 
                    }
                } else {
                    // Arriba -> Subir vista
                    if (state.currentY > 0) { 
                        updateImageDOM(state.currentX, state.currentY - 1); 
                        moved = true; 
                    }
                }
            }

            if (moved) {
                triggerSuccessFeedback();
            } else {
                triggerEdgeFeedback();
            }
        });


        // ==========================================
        // MODO DEMO
        // ==========================================
        function activarModoDemo() {
            demoActive = true;
            imgElement.style.display = 'none';
            demoCanvas.style.display = 'block';
            demoCanvas.width = container.clientWidth;
            demoCanvas.height = container.clientHeight;
        }
        function drawDemoCube(x, y, name) {
            const ctx = demoCanvas.getContext('2d');
            const w = demoCanvas.width; const h = demoCanvas.height;
            ctx.clearRect(0, 0, w, h);
            ctx.fillStyle = "#111"; ctx.fillRect(0,0,w,h);
            ctx.save(); ctx.translate(w/2, h/2);
            if(imgElement.classList.contains('at-edge')) ctx.scale(1.02, 1.02);
            if(imgElement.classList.contains('tap-effect')) ctx.scale(0.98, 0.98);
            ctx.scale(1.56, 1); 
            const rotX = (x - 8) * 15; const rotY = (y - 8) * 10;
            ctx.strokeStyle = "#fff"; ctx.lineWidth = 4; 
            ctx.strokeRect(-100 + rotX, -100 + rotY, 200 - rotX/2, 200 - rotY/2);
            
            // Dibujar lineas de cuadrantes para guia en demo
            ctx.beginPath(); ctx.moveTo(-300, -300); ctx.lineTo(300, 300);
            ctx.moveTo(300, -300); ctx.lineTo(-300, 300);
            ctx.strokeStyle = "rgba(255,255,255,0.1)"; ctx.lineWidth = 1; ctx.stroke();

            ctx.font = "14px sans-serif"; ctx.fillStyle = "#fff"; ctx.textAlign = "center";
            ctx.fillText("MODO TAP", 0, -10);
            ctx.restore();
        }
        window.addEventListener('resize', () => { if(demoActive) { demoCanvas.width = container.clientWidth; demoCanvas.height = container.clientHeight; }});

    </script>
</body>
</html>
